<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregador de Not√≠cias com IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-img-top {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .loading-spinner {
            display: none; /* Oculto por padr√£o */
            margin: 2rem auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">üì∞ AI News Feed</a>
        </div>
    </nav>

    <main class="container my-4">
        <section id="search-section" class="mb-5 p-4 bg-body-tertiary rounded-3">
            <h2>1. Buscar Not√≠cias com IA</h2>
            <p>Digite um t√≥pico para buscar not√≠cias e resumi-las usando Intelig√™ncia Artificial.</p>
            <form id="search-form">
                <div class="input-group">
                    <input type="text" id="search-query" class="form-control" placeholder="Ex: tecnologia, Brasil, finan√ßas..." required>
                    <button class="btn btn-primary" type="submit">Buscar e Resumir</button>
                </div>
            </form>
            <div class="spinner-border text-primary mt-3 loading-spinner" id="search-spinner" role="status">
                <span class="visually-hidden">Buscando...</span>
            </div>
        </section>

        <section id="results-section" class="mb-5">
            <h3 class="border-bottom pb-2 mb-3">Resultados da Busca</h3>
            <div id="news-results" class="row g-4">
                </div>
        </section>

        <hr>

        <section id="posts-section" class="mt-5">
            <h2 class="border-bottom pb-2 mb-3">2. Suas Postagens</h2>
            <div id="saved-posts" class="row g-4">
                </div>
        </section>
    </main>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="editModalLabel">Editar Postagem</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="edit-form">
                <input type="hidden" id="edit-post-id">
                <div class="mb-3">
                    <label for="edit-title" class="form-label">T√≠tulo</label>
                    <input type="text" class="form-control" id="edit-title" required>
                </div>
                <div class="mb-3">
                    <label for="edit-content" class="form-label">Conte√∫do (Resumo IA)</label>
                    <textarea class="form-control" id="edit-content" rows="6" required></textarea>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="save-edit-button">Salvar Altera√ß√µes</button>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIGURA√á√ïES ---
        const GNEWS_API_KEY = "SUA_CHAVE_API_GNEWS";
        const GEMINI_API_KEY = "SUA_CHAVE_API_GEMINI";
        const LOCAL_API_URL = "http://localhost:3000/posts"; // URL do seu json-server

        // --- ELEMENTOS DO DOM ---
        const searchForm = document.getElementById('search-form');
        const searchSpinner = document.getElementById('search-spinner');
        const newsResultsContainer = document.getElementById('news-results');
        const savedPostsContainer = document.getElementById('saved-posts');
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const editForm = document.getElementById('edit-form');
        const saveEditButton = document.getElementById('save-edit-button');


        // --- FUN√á√ïES DA API ---

        /**
         * Busca not√≠cias na GNews.
         */
        async function fetchNews(query) {
            const url = `https://gnews.io/api/v4/search?q=${encodeURIComponent(query)}&lang=pt&country=br&max=6&apikey=${GNEWS_API_KEY}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Erro na GNews: ${response.statusText}`);
                const data = await response.json();
                return data.articles;
            } catch (error) {
                console.error(error);
                alert("Falha ao buscar not√≠cias. Verifique sua chave da GNews.");
                return [];
            }
        }

        /**
         * Resume um texto usando a IA do Google (Gemini).
         */
        async function summarizeWithAI(content) {
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
             try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `Resuma a seguinte not√≠cia em um par√°grafo conciso em portugu√™s: "${content}"` }]
                        }]
                    })
                });
                if (!response.ok) throw new Error(`Erro na API Gemini: ${response.statusText}`);
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error(error);
                alert("Falha ao resumir com IA. Verifique sua chave do Gemini ou o conte√∫do enviado.");
                return "N√£o foi poss√≠vel gerar um resumo.";
            }
        }

        /**
         * Busca os posts salvos no nosso backend (json-server).
         */
        async function fetchSavedPosts() {
            try {
                const response = await fetch(LOCAL_API_URL);
                const posts = await response.json();
                renderSavedPosts(posts);
            } catch (error) {
                console.error("Erro ao buscar posts salvos:", error);
                alert("N√£o foi poss√≠vel carregar os posts. Verifique se o json-server est√° rodando.");
            }
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E MANIPULA√á√ÉO ---

        /**
         * Renderiza os resultados da busca de not√≠cias na tela.
         */
        function renderNewsResults(articles) {
            newsResultsContainer.innerHTML = ''; // Limpa resultados anteriores
            if (articles.length === 0) {
                newsResultsContainer.innerHTML = '<p class="text-center">Nenhum resultado encontrado.</p>';
                return;
            }

            articles.forEach(article => {
                const card = document.createElement('div');
                card.className = 'col-md-4';
                card.innerHTML = `
                    <div class="card h-100">
                        <img src="${article.image || 'https://via.placeholder.com/400x200.png?text=Sem+Imagem'}" class="card-img-top" alt="${article.title}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${article.title}</h5>
                            <p class="card-text flex-grow-1">${article.description}</p>
                            <button class="btn btn-success post-button mt-auto">Postar com Resumo IA</button>
                        </div>
                    </div>
                `;
                // Adiciona o evento de clique para postar
                card.querySelector('.post-button').addEventListener('click', async (e) => {
                    const button = e.target;
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Resumindo...';
                    
                    const summary = await summarizeWithAI(article.content || article.description);

                    const newPost = {
                        title: article.title,
                        content: summary,
                        originalUrl: article.url,
                        imageUrl: article.image
                    };

                    try {
                        await fetch(LOCAL_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newPost)
                        });
                        fetchSavedPosts(); // Recarrega a lista de posts salvos
                    } catch (error) {
                        console.error("Erro ao postar:", error);
                        alert("Falha ao salvar a postagem.");
                    } finally {
                         button.disabled = false;
                         button.textContent = 'Postar com Resumo IA';
                    }
                });
                newsResultsContainer.appendChild(card);
            });
        }
        
        /**
         * Renderiza os posts salvos na tela.
         */
        function renderSavedPosts(posts) {
            savedPostsContainer.innerHTML = '';
            if (posts.length === 0) {
                savedPostsContainer.innerHTML = '<p class="text-center">Voc√™ ainda n√£o tem nenhuma postagem salva.</p>';
                return;
            }

            posts.slice().reverse().forEach(post => { // .slice().reverse() para mostrar os mais recentes primeiro
                const postCard = document.createElement('div');
                postCard.className = 'col-md-6';
                postCard.innerHTML = `
                    <div class="card h-100">
                         <img src="${post.imageUrl || 'https://via.placeholder.com/400x200.png?text=Sem+Imagem'}" class="card-img-top" alt="${post.title}">
                        <div class="card-body">
                            <h5 class="card-title">${post.title}</h5>
                            <p class="card-text">${post.content}</p>
                        </div>
                        <div class="card-footer">
                            <a href="${post.originalUrl}" target="_blank" class="btn btn-sm btn-outline-secondary">Ver Original</a>
                            <button class="btn btn-sm btn-outline-primary edit-button" data-id="${post.id}">Editar</button>
                            <button class="btn btn-sm btn-outline-danger delete-button" data-id="${post.id}">Apagar</button>
                        </div>
                    </div>
                `;
                savedPostsContainer.appendChild(postCard);
            });
        }
        
        // --- EVENT LISTENERS ---

        /**
         * Listener para o formul√°rio de busca.
         */
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = document.getElementById('search-query').value;
            if (!query) return;

            searchSpinner.style.display = 'block';
            newsResultsContainer.innerHTML = '';
            
            const articles = await fetchNews(query);
            renderNewsResults(articles);
            
            searchSpinner.style.display = 'none';
        });

        /**
         * Listeners para os bot√µes de editar e apagar (usando delega√ß√£o de eventos).
         */
        savedPostsContainer.addEventListener('click', async (e) => {
            const target = e.target;
            const postId = target.dataset.id;
            if (!postId) return;

            // Bot√£o APAGAR
            if (target.classList.contains('delete-button')) {
                if (confirm('Tem certeza que deseja apagar esta postagem?')) {
                    try {
                        await fetch(`${LOCAL_API_URL}/${postId}`, { method: 'DELETE' });
                        fetchSavedPosts(); // Recarrega os posts
                    } catch (error) {
                        console.error("Erro ao apagar:", error);
                        alert("Falha ao apagar postagem.");
                    }
                }
            }
            
            // Bot√£o EDITAR
            if (target.classList.contains('edit-button')) {
                try {
                    const response = await fetch(`${LOCAL_API_URL}/${postId}`);
                    const post = await response.json();
                    
                    document.getElementById('edit-post-id').value = post.id;
                    document.getElementById('edit-title').value = post.title;
                    document.getElementById('edit-content').value = post.content;

                    editModal.show();
                } catch (error) {
                    console.error("Erro ao carregar dados para edi√ß√£o:", error);
                    alert("Falha ao carregar dados do post.");
                }
            }
        });

        /**
         * Listener para o bot√£o de salvar no modal de edi√ß√£o.
         */
        saveEditButton.addEventListener('click', async () => {
            const postId = document.getElementById('edit-post-id').value;
            const updatedPost = {
                title: document.getElementById('edit-title').value,
                content: document.getElementById('edit-content').value
            };

            try {
                await fetch(`${LOCAL_API_URL}/${postId}`, {
                    method: 'PATCH', // PATCH atualiza apenas os campos enviados
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedPost)
                });
                
                editModal.hide();
                fetchSavedPosts(); // Recarrega os posts
            } catch(error) {
                console.error("Erro ao salvar edi√ß√£o:", error);
                alert("Falha ao salvar as altera√ß√µes.");
            }
        });


        // --- INICIALIZA√á√ÉO ---
        // Carrega os posts salvos ao iniciar a p√°gina.
        document.addEventListener('DOMContentLoaded', fetchSavedPosts);

    </script>
</body>
</html>
